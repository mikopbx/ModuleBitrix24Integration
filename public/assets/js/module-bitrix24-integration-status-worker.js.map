{"version":3,"file":"module-bitrix24-integration-status-worker.js","names":["ModuleBitrix24IntegrationStatusWorker","$moduleStatus","$","$statusToggle","$submitButton","$formObj","timeOut","timeOutHandle","errorCounts","initialize","restartWorker","changeStatus","window","clearTimeout","timeoutHandle","worker","checkbox","testConnection","api","url","concat","globalRootUrl","on","successTest","PbxApi","onComplete","setTimeout","onSuccess","removeClass","onFailure","onResponse","response","remove","data","visualErrorString","JSON","stringify","messages","replace","Object","keys","length","result","after","addClass","ajax","location","origin","method","dataType","success","$container","empty","$label","globalTranslate","mod_b24_i_ServiceStateTitle","append","Array","isArray","forEach","service","colorClass","state","label","mod_b24_i_GetServiceStateError","error","status","html","mod_b24_i_Connected_v2","mod_b24_i_Disconnected","mod_b24_i_StatusError","mod_b24_i_UpdateStatus"],"sources":["src/module-bitrix24-integration-status-worker.js"],"sourcesContent":["/*\n * MikoPBX - free phone system for small business\n * Copyright (C) 2017-2021 Alexey Portnov and Nikolay Beketov\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License along with this program.\n * If not, see <https://www.gnu.org/licenses/>.\n */\n/* global globalTranslate, Form, Config, PbxApi */\n\n/**\n * Тестирование соединения модуля с Bitrix24\n */\nconst ModuleBitrix24IntegrationStatusWorker = {\n\n\t$moduleStatus: $('#status'),\n\t$statusToggle: $('#module-status-toggle'),\n\t$submitButton: $('#submitbutton'),\n\t$formObj: $('#module-bitrix24-integration-form'),\n\ttimeOut: 3000,\n\ttimeOutHandle: '',\n\terrorCounts: 0,\n\tinitialize() {\n\t\tModuleBitrix24IntegrationStatusWorker.restartWorker();\n\t},\n\trestartWorker() {\n\t\tModuleBitrix24IntegrationStatusWorker.errorCounts = 0;\n\t\tModuleBitrix24IntegrationStatusWorker.changeStatus('Updating');\n\t\twindow.clearTimeout(ModuleBitrix24IntegrationStatusWorker.timeoutHandle);\n\t\tModuleBitrix24IntegrationStatusWorker.worker();\n\t},\n\tworker() {\n\t\tif (ModuleBitrix24IntegrationStatusWorker.$statusToggle.checkbox('is checked')) {\n\t\t\tModuleBitrix24IntegrationStatusWorker.testConnection();\n\t\t} else {\n\t\t\tModuleBitrix24IntegrationStatusWorker.errorCounts = 0;\n\t\t\tModuleBitrix24IntegrationStatusWorker.changeStatus('Disconnected');\n\t\t}\n\t},\n\n\t/**\n\t * Проверка соединения с сервером Bitrix24\n\t * @returns {boolean}\n\t */\n\ttestConnection() {\n\t\t$.api({\n\t\t\turl: `${globalRootUrl}module-bitrix24-integration/checkState`,\n\t\t\ton: 'now',\n\t\t\tsuccessTest: PbxApi.successTest,\n\t\t\tonComplete() {\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.timeoutHandle = window.setTimeout(\n\t\t\t\t\tModuleBitrix24IntegrationStatusWorker.worker,\n\t\t\t\t\tModuleBitrix24IntegrationStatusWorker.timeOut,\n\t\t\t\t);\n\t\t\t},\n\t\t\tonSuccess() {\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.changeStatus('Connected');\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.errorCounts = 0;\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.$formObj.removeClass('error');\n\t\t\t},\n\t\t\tonFailure() {\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.errorCounts++;\n\t\t\t\tif (ModuleBitrix24IntegrationStatusWorker.errorCounts > 3){\n\t\t\t\t\tModuleBitrix24IntegrationStatusWorker.changeStatus('ConnectionError');\n\t\t\t\t}\n\t\t\t},\n\t\t\tonResponse(response) {\n\t\t\t\t$('.message.ajax').remove();\n\t\t\t\tif (ModuleBitrix24IntegrationStatusWorker.errorCounts < 3){\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Debug mode\n\t\t\t\tif (typeof (response.data) !== 'undefined') {\n\t\t\t\t\tlet visualErrorString = JSON.stringify(response.messages, null, 2);\n\n\t\t\t\t\tif (typeof visualErrorString === 'string') {\n\t\t\t\t\t\tvisualErrorString = visualErrorString.replace(/\\n/g, '<br/>');\n\t\t\t\t\t\tvisualErrorString = visualErrorString.replace(/[\\[\\]']+/g,'');\n\n\t\t\t\t\t\tif (Object.keys(response).length > 0 && response.result !== true) {\n\t\t\t\t\t\t\tModuleBitrix24IntegrationStatusWorker.$moduleStatus\n\t\t\t\t\t\t\t\t.after(`<div class=\"ui error icon message ajax\">\n\t\t\t\t\t\t\t\t\t<i class=\"exclamation circle icon\"></i>\n\t\t\t\t\t\t\t\t\t<div class=\"content\">\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t<pre style='white-space: pre-wrap'>${visualErrorString}</pre>\n\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t  \n\t\t\t\t\t\t\t\t</div>`);\n\t\t\t\t\t\t\tModuleBitrix24IntegrationStatusWorker.$formObj.addClass('error');\n\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\t$.ajax({\n\t\t\turl: window.location.origin + '/pbxcore/api/bitrix-integration/workers/state',\n\t\t\tmethod: 'GET',\n\t\t\tdataType: 'json',\n\t\t\tsuccess: function(response) {\n\t\t\t\tconst $container = $('#status-workers');\n\t\t\t\t$container.empty();\n\t\t\t\tconst $label = $('<div class=\"ui small basic label\" style=\"font-weight: bold; padding: 0.6em 1em;\">'+globalTranslate.mod_b24_i_ServiceStateTitle+'</div>');\n\t\t\t\t$container.append($label);\n\t\t\t\tif (response.result === true && Array.isArray(response.data)) {\n\t\t\t\t\t// Для каждого сервиса создаём label\n\t\t\t\t\tresponse.data.forEach(service => {\n\t\t\t\t\t\tconst colorClass = service.state === 'OK' ? 'green' : 'red';\n\t\t\t\t\t\tconst $label = $(`<div class=\"ui ${colorClass} label\">${service.label}</div>`);\n\t\t\t\t\t\t$container.append($label);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\t// Если result: false или data не массив\n\t\t\t\t\tconst $label = $('<div class=\"ui red label\">'+globalTranslate.mod_b24_i_GetServiceStateError+'</div>');\n\t\t\t\t\t$container.append($label);\n\t\t\t\t}\n\t\t\t},\n\t\t\terror: function() {\n\t\t\t\tconst $container = $('#status-workers');\n\t\t\t\t$container.empty();\n\t\t\t\tconst $label = $('<div class=\"ui red label\">'+globalTranslate.mod_b24_i_GetServiceStateError+'</div>');\n\t\t\t\t$container.append($label);\n\t\t\t}\n\t\t});\n\t},\n\t/**\n\t * Updates module status on the right corner label\n\t * @param status\n\t */\n\tchangeStatus(status) {\n\t\tModuleBitrix24IntegrationStatusWorker.$moduleStatus\n\t\t\t.removeClass('grey')\n\t\t\t.removeClass('yellow')\n\t\t\t.removeClass('green')\n\t\t\t.removeClass('red');\n\n\t\tswitch (status) {\n\t\t\tcase 'Connected':\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.$moduleStatus\n\t\t\t\t\t.addClass('green')\n\t\t\t\t\t.html(globalTranslate.mod_b24_i_Connected_v2);\n\t\t\t\tbreak;\n\t\t\tcase 'Disconnected':\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.$moduleStatus\n\t\t\t\t\t.addClass('grey')\n\t\t\t\t\t.html(globalTranslate.mod_b24_i_Disconnected);\n\t\t\t\tbreak;\n\t\t\tcase 'ConnectionError':\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.$moduleStatus\n\t\t\t\t\t.addClass('red')\n\t\t\t\t\t.html(globalTranslate.mod_b24_i_StatusError);\n\t\t\t\tbreak;\n\t\t\tcase 'Updating':\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.$moduleStatus\n\t\t\t\t\t.addClass('grey')\n\t\t\t\t\t.html(`<i class=\"spinner loading icon\"></i>${globalTranslate.mod_b24_i_UpdateStatus}`);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tModuleBitrix24IntegrationStatusWorker.$moduleStatus\n\t\t\t\t\t.addClass('red')\n\t\t\t\t\t.html(globalTranslate.mod_b24_i_StatusError);\n\t\t\t\tbreak;\n\t\t}\n\t}\n}"],"mappings":"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","ignoreList":[]}